---
// src/pages/strapi-blog/[id].astro
import BaseLayout from '@/layouts/BaseLayout.astro';
import { fetchStrapi } from '@/lib/strapi';

// 1. 生成所有Strapi博客的静态路径
export async function getStaticPaths() {
  const GET_BLOGS_LIST = `
    query {
      blogs {
        slug // 改为获取 slug 字段
      }
    }
  `;
  const data = await fetchStrapi({ query: GET_BLOGS_LIST });
  return data?.blogs?.map((blog) => ({
    params: { slug: blog.slug }, // 参数名改为 slug
  })) || [];
}

// 2. 获取当前博客的详细内容
const { slug } = Astro.params; // 获取 URL 中的 slug 参数
const GET_BLOG_BY_SLUG = `
  query GetBlog($slug: String!) {
    blogs(filters: { slug: { eq: $slug } }) { // 使用 filters 进行筛选
      documentId
      title
      publishedAt
      author
      content
      cover { url }
    }
  }
`;
const data = await fetchStrapi({ query: GET_BLOG_BY_SLUG, variables: { slug } });
const post = data?.blogs?.[0]; // 注意返回的是数组，取第一项

// 如果未找到文章，返回404页面
if (!post) {
  return Astro.redirect('/404');
}
---

<BaseLayout title={post.title} description={`作者：${post.author}`}>
  <article class="prose max-w-none">
    <h1 class="text-3xl font-bold">{post.title}</h1>
    <div class="text-gray-600 mt-2">
      作者：{post.author} · 发布时间：{new Date(post.publishedAt).toLocaleDateString()}
    </div>
    {
      post.cover?.url && (
        <img src={post.cover.url} alt={post.title} class="my-6 rounded-lg w-full" />
      )
    }
    <div set:html={post.content}></div>
  </article>
</BaseLayout>
